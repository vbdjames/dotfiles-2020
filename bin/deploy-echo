#!/bin/bash
echo ""
echo "***************************************************"
echo "* This script assists in the deployment of Echo   *"
echo "* Agent and Echo Admin to the alternate cluster   *"
echo "*                                                 *"
echo "* This is an Alpha release - pay close attention  *"
echo "* and be prepared to abort if anything goes wrong *"
echo "***************************************************"
echo ""



AGENT_LOC=$(curl -vs chesechoprimary.internal 2>&1 | grep "Location" | sed 's/.*\(prod[1-9]echo\).*/\1/' )
case $AGENT_LOC in
    prod1echo|prod2echo)
        ACTIVE_AGENT_CLUSTER="Echo1Chesapeake"
        ACTIVE_AGENT_PRIMARY_HOST="prod1echo"
        ACTIVE_AGENT_SECONDARY_HOST="prod2echo"
        TARGET_AGENT_CLUSTER="Echo2Chesapeake"
        TARGET_AGENT_PRIMARY_HOST="prod3echo"
        TARGET_AGENT_SECONDARY_HOST="prod4echo"
        ;;
    prod3echo|prod4echo)
        ACTIVE_AGENT_CLUSTER="Echo1Chesapeake"
        ACTIVE_AGENT_PRIMARY_HOST="prod3echo"
        ACTIVE_AGENT_SECONDARY_HOST="prod4echo"
        TARGET_AGENT_CLUSTER="Echo2Chesapeake"
        TARGET_AGENT_PRIMARY_HOST="prod1echo"
        TARGET_AGENT_SECONDARY_HOST="prod2echo"
        ;;
    prod5echo|prod6echo)
        ACTIVE_AGENT_CLUSTER="Echo1Suffolk"
        ACTIVE_AGENT_PRIMARY_HOST="prod5echo"
        ACTIVE_AGENT_SECONDARY_HOST="prod6echo"
        TARGET_AGENT_CLUSTER="Unknown"
        TARGET_AGENT_PRIMARY_HOST="Unknown"
        TARGET_AGENT_SECONDARY_HOST="Unknown"
        ;;
    *)
        ACTIVE_AGENT_CLUSTER="Unknown: $AGENT_LOC"
        ACTIVE_AGENT_PRIMARY_HOST="Unknown"
        ACTIVE_AGENT_SECONDARY_HOST="Unknown"
        TARGET_AGENT_CLUSTER="Unknown"
        TARGET_AGENT_PRIMARY_HOST="Unknown"
        TARGET_AGENT_SECONDARY_HOST="Unknown"
        ;;
esac

# ADMIN_LOC=$(curl -vs chesechoprimary.internal/admin 2>&1 | grep "Location" | sed 's/.*\(prod[1-9]echoadm\).*/\1/' )

echo "Echo agent currently deployed at $ACTIVE_AGENT_CLUSTER, deploying to $TARGET_AGENT_CLUSTER"
# echo "Echo admin currently deployed at $ADMIN_CLUSTER, deploying to $ADMIN_TARGET"
echo ""

echo "The next screen should show normal user activity on the primary host"
read -p "Press enter to continue, and <CTL-C> to return to this script"
ssh $ACTIVE_AGENT_PRIMARY_HOST tail -F /jboss/server/all/log/server.log
echo ""

echo "The next screen should show normal user activity on the secondary host"
read -p "Press enter to continue, and <CTL-C> to return to this script"
ssh $ACTIVE_AGENT_SECONDARY_HOST tail -F /jboss/server/all/log/server.log
echo ""

echo "The next screen should NOT show user activity on the primary target host"
read -p "Press enter to continue, and <CTL-C> to return to this script"
ssh $TARGET_AGENT_PRIMARY_HOST tail -F /jboss/server/all/log/server.log
echo ""

echo "The next screen should NOT show user activity on the secondary target host"
read -p "Press enter to continue, and <CTL-C> to return to this script"
ssh $TARGET_AGENT_SECONDARY_HOST tail -F /jboss/server/all/log/server.log
echo ""





echo "Getting latest stable build artifact from Jenkins..."
curl http://prod1git.internal:8080/job/echo-master/lastStableBuild/artifact/*zip*/archive.zip --output archive.zip
echo "Unzipping arhive..."
unzip archive.zip
echo ""

echo "Copying artifacts..."
AGENT_PRIMARY_TARGET=test2echo
AGENT_SECONDARY_TARGET=test2echo
scp archive/dist/map-echo* $AGENT_PRIMARY_TARGET:~

echo "Connecting to primary host to deploy artifacts..."
read -p "Press enter to continue, script will proceed on target host"
ssh $AGENT_PRIMARY_TARGET ./deploy_echo

echo "Connecting to secondary host to stop JBoss..."
read -p "Press enter to continue, script will proceed on target host"
ssh $AGENT_SECONDARY_TARGET ./stop_jboss

echo "Connecting to primary host to stop JBoss.a.."
read -p "Press enter to continue, script will proceed on target host"
ssh $AGENT_PRIMARY_TARGET ./stop_jboss

echo "Connecting to primary host to start JBoss..."
read -p "Press enter to continue, script will proceed on target host"
ssh $AGENT_PRIMARY_TARGET ./start_jboss

echo "Connecting to secondary host to start JBoss..."
read -p "Press enter to continue, script will proceed on target host"
ssh $AGENT_SECONDARY_TARGET ./start_jboss


